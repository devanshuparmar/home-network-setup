#!/bin/bash

# Proxmox Network Configuration Script and Documentation

# ------------------------------
# Overview
# ------------------------------
# This script contains Proxmox network configuration settings
# used in a homelab environment. Proxmox is configured to use
# a wireless interface (wlp4s0) for internet access and an Ethernet
# interface (eno1) bridged to vmbr0. A secondary bridge, vmbr1, is
# used for internal network communication.

# ------------------------------
# Network Interfaces Configuration (/etc/network/interfaces)
# ------------------------------

# network interface settings; autogenerated
# Please do NOT modify this file directly, unless you know what
# you're doing.
#
# If you want to manage parts of the network configuration manually,
# please utilize the 'source' or 'source-directory' directives to do
# so.
# PVE will preserve these directives, but will NOT read its network
# configuration from sourced files, so do not attempt to move any of
# the PVE managed interfaces into external files!

iface lo inet loopback

iface eno1 inet manual
	
auto wlp4s0
iface wlp4s0 inet dhcp

auto vmbr0
iface vmbr0 inet static
	address 192.168.1.1
#	gateway 10.0.0.1
	netmask 255.255.255.0
	bridge-ports eno1
	bridge-stp off
	bridge-fd 0

auto vmbr1
iface vmbr1 inet static
	address 192.168.2.1
	netmask 255.255.255.0
	bridge-ports none
	bridge-stp off
	bridge-fd 0
#firewall-server conn

source /etc/network/interfaces.d/*

# ------------------------------
# WPA Supplicant Configuration (/etc/wpa_supplicant/wpa_supplicant.conf)
# ------------------------------
# This section contains WiFi configuration settings used by wlp4s0.
echo "Creating WPA supplicant configuration for wlp4s0"
cat <<EOL > /etc/wpa_supplicant/wpa_supplicant.conf

ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
country=CA

network={
    ssid="WIFI-NAME"
    psk="PASSWORD"
    priority=1
}
EOL

# ------------------------------
# Key Points and Considerations
# ------------------------------
# - The Proxmox host uses wlp4s0 to connect to the internet via DHCP.
# - Bridged networking is facilitated through vmbr0 (external) and vmbr1 (internal).
# - Configuration files should be adjusted as needed for stability and connectivity.

# ------------------------------
# Example Use Cases
# ------------------------------
# External Network Access:
# - VMs connected to vmbr0 can access external networks through eno1.
# Internal Network Communication:
# - VMs connected to vmbr1 are used for internal communications and isolation.

# ------------------------------
# Troubleshooting and Future Plans
# ------------------------------
# - Monitor WiFi stability for wlp4s0.
# - Plan to configure redundant interfaces for improved network reliability.
# - Consider wired connections where possible for enhanced performance.

echo "Proxmox network configuration script completed."

